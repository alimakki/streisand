{% for item in vpn_client_names.results %}

conn {{ item.stdout }}
    also=ikev2
    rightid=%fromcert
    rightcert={{ item.stdout }}

{% endfor %}

conn ikev2
    left={{ ansible_default_ipv4.address }}
    leftca=ca-certificate
    leftcert={{ ikev2_server_name.stdout }}
    leftid=%fromcert
    leftsendcert=always
    leftsubnet={{ ansible_default_ipv4.address }}/32
    leftrsasigkey=%cert
    # Clients
    # right=%any we only want the ones we generated
    rightaddresspool=10.0.10.1-10.0.10.254
    # optional rightid with restrictions
    rightca=%same
    rightrsasigkey=%cert
    # connection configuration
    # DNS servers for clients to use
{% for item in upstream_dns_servers %}
    modecfgdns{{ loop.index }} = {{ item }}
{% endfor %}
    narrowing=yes
    dpddelay=30
    dpdtimeout=120
    dpdaction=clear
    auto=add
    ikev2=insist
    rekey=no
    sha2-truncbug=no
    fragmentation=yes
    encapsulation=yes
    ike=aes_gcm256_c,aes_gcm128_c,aes256-sha2_512;dh19,aes128-sha2_512;dh19
    phase2alg=aes_gcm256_c,aes_gcm128_c,aes256-sha2_512;dh19,aes128-sha2_512;dh19
    phase2=esp
