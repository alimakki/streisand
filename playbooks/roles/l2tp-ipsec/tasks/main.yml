---
- name: Install the Libreswan dependencies that are required for compilation
  apt:
    name: "{{ item }}"
  with_items: "{{ libreswan_compilation_dependencies }}"

- name: Install xmlto (without the extraordinarily large number of packages it normally recommends)
  apt:
    name: xmlto
    install_recommends: no

- name: Retrieve the Libreswan source code
  include_role:
    name: download-and-verify
  vars:
    project_name: "The Libreswan Project"
    project_download_baseurl: "{{ libreswan_download_baseurl }}"
    project_download_files: "{{ libreswan_download_files }}"
    project_download_location: "{{ libreswan_src_directory }}"
    project_signer_keyid: "{{ libreswan_gpg_keyid }}"

- name: Extract the Libreswan source code
  unarchive:
    copy: no
    src: "{{ libreswan_source_location }}"
    dest: /usr/local/src
    owner: root
    group: root
    creates: "{{ libreswan_compilation_directory }}/README"

- name: Compile and install Libreswan (this will take a while)
  shell: make -j {{ ansible_processor_cores }} programs && make install
  args:
    chdir: "{{ libreswan_compilation_directory }}"

- name: Generate IPsec configuration file
  template:
    src: ipsec.conf.j2
    dest: /etc/ipsec.d/l2tp.conf
    owner: root
    group: root
    mode: 0644

- name: Generate a random IPsec pre-shared key
  shell: "{{ streisand_word_gen.psk | trim }}  > {{ ipsec_preshared_key_file }}"
  args:
    creates: "{{ ipsec_preshared_key_file }}"

- name: Set permissions on the IPsec pre-shared key
  file:
    path: "{{ ipsec_preshared_key_file }}"
    owner: root
    group: root
    mode: 0600

- name: Register the IPsec pre-shared key
  command: cat {{ ipsec_preshared_key_file }}
  register: ipsec_preshared_key
  changed_when: False

- name: Register the IPsec pre-shared key as base64
  shell: cat {{ ipsec_preshared_key_file }} | tr -d '\n' | base64
  register: ipsec_preshared_key_base64
  changed_when: False

- name: Generate the IPsec PSK secrets file
  template:
    src: ipsec.psk.secrets.j2
    dest: /etc/ipsec.d/ipsec.psk.secrets
    owner: root
    group: root
    mode: 0600

- name: Create the xl2tpd configuration directory
  file:
    path: /etc/xl2tpd
    owner: root
    group: root
    mode: 0750
    state: directory

- name: Generate xl2tpd configuration file
  template:
    src: xl2tpd.conf.j2
    dest: /etc/xl2tpd/xl2tpd.conf
    owner: root
    group: root
    mode: 0644

- name: Copy xl2tpd secrets file
  copy:
    src: l2tp-secrets
    dest: /etc/xl2tpd/l2tp-secrets
    owner: root
    group: root
    mode: 0600

- name: Generate PPP options file
  template:
    src: options.xl2tpd.j2
    dest: "{{ ppp_options_file }}"
    owner: root
    group: root
    mode: 0644

- name: Generate a random CHAP password
  shell: "{{ streisand_word_gen.weak_password | trim }} > {{ chap_password_file }}"
  args:
    creates: "{{ chap_password_file }}"

- name: Set permissions on the CHAP password
  file:
    path: "{{ chap_password_file }}"
    owner: root
    group: root
    mode: 0600

- name: Register the CHAP password
  command: cat {{ chap_password_file }}
  register: chap_password
  changed_when: False

- name: Generate CHAP secrets file
  template:
    src: chap-secrets.j2
    dest: /etc/ppp/chap-secrets
    owner: root
    group: root
    mode: 0600

# Ensure l2tp firewall rules are in place
- import_tasks: firewall.yml

# Generate l2tp instructions and mobile profiles
- import_tasks: docs.yml
